<html>
<head>
  <title></title>
</head>
<body>
  <h3>Debug Calls:</h3>
  <ul class="debug"></ul>
</body>
<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.9/require.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
  console.log = function(txt) {
    $('.debug').append('<li>' + txt.toString() + '</li>');
  };

  require.config({
    baseUrl: './assets',
    paths: {
      knex: '../knex'
    }
  });

  require(['knex', 'bluebird'], function(knex, Promise) {

    var Knex = require('knex')

    var x = 0;

    var knex = window.knex = Knex({
      client: 'sqlite',
      name: 'knex_demo',
      debug: true
    });

    knex.schema.hasTable('items')
      .tap(function(exists) {
        if (!exists) {
          return knex.schema.createTable('items', function(t) {
            t.increments();
            t.string('type');
            t.bool('enabled').defaultTo(false);
          });
        } else {
          return knex('items').truncate().then(function() {
            return knex('items');
          });
        }
      }).then(function() {
        knex.transaction(function(t) {
          return Promise.all([
            knex('items').transacting(t).insert({type: 'tests'}),
            knex('items').transacting(t).insert({type: 'items'}),
            knex('items').transacting(t).insert({type: 'cool'}),
          ])
          .then(function() {
            return knex('items').transacting(t);
          })
          .then(function() {
            return knex('item').transacting(t).truncate();
          })
          .then(function() {
            t.rollback('msg');
          })
          .catch(function(e) {
            console.log(e);
            return knex('items');
          })
          .then(function(resp) {
            if (resp.length === 0) {
              console.log('No response, transaction was properly rolled back');
            }
          });
      });
    }).catch(function(err) {
      console.log(err);
    });
  })
</script>
</html>