!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(["bluebird","lodash"],a):"undefined"!=typeof window?window.knex=a():"undefined"!=typeof global?global.knex=a():"undefined"!=typeof self&&(self.knex=a())}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};a[g][0].call(j.exports,function(b){var c=a[g][1][b];return e(c?c:b)},j,j.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=a("../lib/helpers").Helpers,e=function(){};e.prototype={getRawConnection:function(){},query:function(){},getConnection:function(){},releaseConnection:function(){},startTransaction:function(){},finishTransaction:function(){},poolDefaults:function(){}},e.extend=d.extend,c.ClientBase=e},{"../lib/helpers":15}],2:[function(a,b,c){var d=a("lodash"),e=a("../../lib/raw").Raw,f=a("../../lib/helpers").Helpers,g=[].push,h=["columns","aggregates","from","joins","wheres","groups","havings","orders","limit","offset","unions"];c.baseGrammar={toSql:function(a){return a.type=a.type||"select",a.grammar["compile"+f.capitalize(a.type)](a)},getBindings:function(a){for(var b=a.bindings,c=[],d=0,e=b.length;e>d;d++)b[d]&&"Raw"===b[d]._source?g.apply(c,b[d].bindings):c.push(b[d]);return c},compileSelect:function(a){var b=[];d.isEmpty(a.columns)&&d.isEmpty(a.aggregates)&&(a.columns=["*"]);for(var c=0,e=h.length;e>c;c++){var g=h[c],i=d.result(a,g);null!=i&&b.push(this["compile"+f.capitalize(g)](a,i))}return a.transaction&&a.flags.selectMode&&b.push(this["compile"+a.flags.selectMode](a)),d.compact(b).join(" ")},compileAggregates:function(a){for(var b,c,d=[],e=0,f=a.aggregates.length;f>e;e++){var g=a.aggregates[e];-1!==g.columns.toLowerCase().indexOf(" as ")?(b=g.columns.split(" "),c=b[0]):c=g.columns,d.push(g.type+"("+this.wrap(c)+")"+(b?" as "+this.wrap(b[2]):""))}return d.join(", ")},compileColumns:function(a,b){return(a.flags.distinct?"select distinct":"select")+(d.isArray(b)&&d.isEmpty(b)?"":" "+this.columnize(b))},compileFrom:function(a,b){return"from "+this.wrapTable(b)},compileJoins:function(a,b){for(var c=[],d=0,e=b.length;e>d;d++){for(var f=b[d],g=[],h=0,i=f.clauses.length;i>h;h++){var j=f.clauses[h];g.push([j.bool,this.wrap(j.first),j.operator,this.wrap(j.second)].join(" "))}g[0]=g[0].replace(/and |or /,""),c.push(f.joinType+" join "+this.wrapTable(f.table)+" on "+g.join(" "))}return c.join(" ")},compileWheres:function(a){var b=[],c=a.wheres;if(0===c.length)return"";for(var d=0,e=c.length;e>d;d++){var f=c[d];b.push(f.bool+" "+this["where"+f.type](a,f))}return b.length>0?"where "+b.join(" ").replace(/and |or /,""):""},compileUnions:function(a){for(var b="",c=0,d=a.unions.length;d>c;c++){var e=a.unions[c];b+=(e.all?"union all ":"union ")+this.compileSelect(e.query)}return b},whereNested:function(a,b){return"("+this.compileWheres(b.query).slice(6)+")"},whereSub:function(a,b){return this.wrap(b.column)+" "+b.operator+" ("+this.compileSelect(b.query)+")"},whereBasic:function(a,b){return this.wrap(b.column)+" "+b.operator+" "+this.parameter(b.value)},whereExists:function(a,b){return"exists ("+this.compileSelect(b.query)+")"},whereNotExists:function(a,b){return"not exists ("+this.compileSelect(b.query)+")"},whereIn:function(a,b){return this.wrap(b.column)+" in ("+this.parameterize(b.value)+")"},whereNotIn:function(a,b){return this.wrap(b.column)+" not in ("+this.parameterize(b.value)+")"},whereInSub:function(a,b){return this.wrap(b.column)+" in ("+this.compileSelect(b.query)+")"},whereNotInSub:function(a,b){return this.wrap(b.column)+" not in ("+this.compileSelect(b.query)+")"},whereBetween:function(a,b){return this.wrap(b.column)+" between ? and ?"},whereNull:function(a,b){return this.wrap(b.column)+" is null"},whereNotNull:function(a,b){return this.wrap(b.column)+" is not null"},whereRaw:function(a,b){return b.sql},compileGroups:function(a,b){return"group by "+this.columnize(b)},compileHavings:function(a,b){if(b.length){var c="having "+b.map(function(a){return"Raw"===a.type?a.bool+" "+a.sql:a.bool+" "+this.wrap(a.column)+" "+a.operator+" "+this.parameter(a.value)},this);return c.replace(/and |or /,"")}},compileOrders:function(a,b){return b.length>0?"order by "+b.map(function(a){return""+this.wrap(a.column)+" "+a.direction},this).join(", "):void 0},compileLimit:function(a,b){return"limit "+b},compileOffset:function(a,b){return"offset "+b},compileInsert:function(a){var b=a.values,c=this.wrapTable(a.table),e=d.pluck(b[0],0),f=[];a.wheres.length>0&&this.clearWhereBindings(a);for(var g=0,h=b.length;h>g;++g)f.push("("+this.parameterize(d.pluck(b[g],1))+")");return"insert into "+c+" ("+this.columnize(e)+") values "+f.join(", ")},clearWhereBindings:function(a){for(var b=a.wheres,c=0,e=0,f=b.length;f>e;e++){var g=b[e];c+=d.isArray(g.value)?g.value.length:g.query?g.query.bindings.length:1}a.bindings=a.bindings.slice(c)},compileUpdate:function(a){for(var b=a.values,c=this.wrapTable(a.table),d=[],e=0,f=b.length;f>e;e++){var g=b[e];d.push(this.wrap(g[0])+" = "+this.parameter(g[1]))}return"update "+c+" set "+d.join(", ")+" "+this.compileWheres(a)},compileDelete:function(a){var b=this.wrapTable(a.table),c=d.isEmpty(a.wheres)?"":this.compileWheres(a);return"delete from "+b+" "+c},compileTruncate:function(a){return"truncate "+this.wrapTable(a.table)},compileForUpdate:function(){return"for update"},compileForShare:function(){return"for share"},wrap:function(a){var b;if(a instanceof e)return a.sql;if(d.isNumber(a))return a;if(-1!==a.toLowerCase().indexOf(" as "))return b=a.split(" "),this.wrap(b[0])+" as "+this.wrap(b[2]);var c=[];b=a.split(".");for(var f=0,g=b.length;g>f;f=++f)a=b[f],0===f&&b.length>1?c.push(this.wrapTable(a)):c.push(this.wrapValue(a));return c.join(".")},wrapArray:function(a){return d.map(a,this.wrap,this)},wrapTable:function(a){return a instanceof e?a.sql:this.wrap(a)},columnize:function(a){return d.isArray(a)||(a=[a]),d.map(a,this.wrap,this).join(", ")},parameterize:function(a){return d.isArray(a)||(a=[a]),d.map(a,this.parameter,this).join(", ")},parameter:function(a){return a instanceof e?a.sql:"?"}}},{"../../lib/helpers":15,"../../lib/raw":19,lodash:!1}],3:[function(a,b,c){var d=a("lodash"),e=a("./grammar").baseGrammar,f=a("../../lib/schemabuilder").SchemaBuilder,g=a("../../lib/helpers").Helpers,h=a("../../lib/raw").Raw;c.baseSchemaGrammar={toSql:function(a){a=a.clone(),a.columns.length>0&&!a.creating()&&a.commands.unshift({name:"add"}),a.commands.push({name:"additional"});for(var b=0,c=a.columns.length;c>b;b++)for(var e=a.columns[b],f=["primary","unique","index","foreign"],h=0,i=f.length;i>h;h++){var j=f[h],k="is"+g.capitalize(j);e[k]!==!0?d.has(e,k)&&a[j](e.name,e[k],e):a[j](e,null)}var l=[];for(b=0,c=a.commands.length;c>b;b++){var m=a.commands[b],n="compile"+g.capitalize(m.name);if(d.has(this,n)){var o=this[n](a,m);o&&(l=l.concat(o))}}return l},compileForeign:function(a,b){var c;if(b.foreignTable&&b.foreignColumn){var d=this.wrapTable(a),e=this.columnize(b.columns),f=this.wrapTable(b.foreignTable),g=this.columnize(b.foreignColumn);c="alter table "+d+" add constraint "+b.index+" ",c+="foreign key ("+e+") references "+f+" ("+g+")",b.commandOnDelete&&(c+=" on delete "+b.commandOnDelete),b.commandOnUpdate&&(c+=" on update "+b.commandOnUpdate)}return c},getColumns:function(a){for(var b=[],c=0,d=a.columns.length;d>c;c++){var e=a.columns[c],f=this.wrap(e)+" "+this.getType(e,a);b.push(this.addModifiers(f,a,e))}return b},addModifiers:function(a,b,c){for(var e=0,f=this.modifiers.length;f>e;e++){var g=this.modifiers[e],h="modify"+g;d.has(this,h)&&(a+=this[h](b,c)||"")}return a},getType:function(a,b){return this["type"+g.capitalize(a.type)](a,b)},prefixArray:function(a,b){return d.map(b,function(b){return a+" "+b})},wrapTable:function(a){return a instanceof f&&(a=a.table),e.wrapTable.call(this,a)},wrap:function(a){return a&&a.name&&(a=a.name),e.wrap.call(this,a)},getDefaultValue:function(a){return a instanceof h?a.sql:a===!0||a===!1?parseInt(a,10):""+a},getCommandByName:function(a,b){var c=this.getCommandsByName(a,b);return c.length>0?c[0]:void 0},getCommandsByName:function(a,b){return d.filter(a.commands,function(a){return a.name==b})||[]},compileAdditional:function(){},compileCreateTable:function(a){var b=this.getColumns(a).join(", ");return"create table "+this.wrapTable(a)+" ("+b+")"},compileDropTable:function(a){return"drop table "+this.wrapTable(a)},compileDropTableIfExists:function(a){return"drop table if exists "+this.wrapTable(a)},compileDropIndex:function(a,b){return"drop index "+b.index},typeBigInteger:function(a){return this.typeInteger(a)},typeString:function(a){return"varchar("+a.length+")"},typeText:function(){return"text"},typeTinyInteger:function(){return"tinyint"},typeTime:function(){return"time"},typeDate:function(){return"date"},typeBinary:function(){return"blob"},typeJson:function(){return"text"},typeUuid:function(){return"char(36)"},typeSpecificType:function(a){return a.specific},modifyNullable:function(a,b){return b.isNullable===!1?" not null":void 0},modifyDefault:function(a,b){return void 0!=b.defaultValue?" default '"+this.getDefaultValue(b.defaultValue)+"'":void 0}}},{"../../lib/helpers":15,"../../lib/raw":19,"../../lib/schemabuilder":20,"./grammar":2,lodash:!1}],4:[function(a,b,c){var d=a("lodash"),e=a("../../../lib/helpers").Helpers,f=a("../grammar").baseGrammar;c.grammar=d.defaults({wrapValue:function(a){return"*"!==a?e.format('"%s"',a):"*"},compileOrders:function(a,b){return 0!==b.length?"order by "+b.map(function(a){return this.wrap(a.column)+" collate nocase "+a.direction},this).join(", "):void 0},compileInsert:function(a){var b=a.values,c=this.wrapTable(a.table),e=d.pluck(b[0],0);if(a.wheres.length>0&&this.clearWhereBindings(a),1===b.length){var f="insert into "+c+" ";return f+=0===e.length?"default values":"("+this.columnize(e)+") values ("+this.parameterize(d.pluck(b[0],1))+")"}for(var g=[],h=0,i=e.length;i>h;h++)g.push("? as "+this.wrap(e[h]));var j=g.join(", ");for(g=[],h=0,i=b.length;i>h;h++)g.push(j);return"insert into "+c+" ("+this.columnize(e)+") select "+g.join(" union all select ")},compileTruncate:function(a){var b=[],c=this.wrapTable(a.table);return b.push("delete from sqlite_sequence where name = "+c),b.push("delete from "+c),b},compileForUpdate:function(){},compileForShare:function(){}},f)},{"../../../lib/helpers":15,"../grammar":2,lodash:!1}],5:[function(a,b,c){var d=a("lodash"),e=a("./grammar").grammar,f=a("../schemagrammar").baseSchemaGrammar;c.schemaGrammar=d.defaults({modifiers:["Nullable","Default","Increment"],getBindings:function(a){return"columnExists"===a.type?[]:e.getBindings(a)},compileTableExists:function(){return"select * from sqlite_master where type = 'table' and name = ?"},compileColumnExists:function(a){return"PRAGMA table_info("+this.wrapTable(a)+")"},compileCreateTable:function(a){var b=this.getColumns(a).join(", "),c="create table "+this.wrapTable(a)+" ("+b;return c+=this.addForeignKeys(a),c+=this.addPrimaryKeys(a)||"",c+=")"},addForeignKeys:function(a){for(var b="",c=this.getCommandsByName(a,"foreign"),d=0,e=c.length;e>d;d++){var f=c[d],g=this.columnize(f.columns),h=this.wrapTable(f.foreignTable),i=this.columnize([f.foreignColumn]);b+=", foreign key("+g+") references "+h+"("+i+")"}return b},addPrimaryKeys:function(a){var b=this.getCommandByName(a,"primary");if(b&&(b.columns=d.reduce(b.columns,function(a,b){return b.autoIncrement!==!0&&a.push(b),a},[]),b.columns.length>0)){var c=this.columnize(b.columns);return", primary key ("+c+")"}},compileAdd:function(a){for(var b=this.wrapTable(a),c=this.prefixArray("add column",this.getColumns(a)),d=[],e=0,f=c.length;f>e;e++)d.push("alter table "+b+" "+c[e]);return d},compileUnique:function(a,b){var c=this.columnize(b.columns),d=this.wrapTable(a);return"create unique index "+b.index+" on "+d+" ("+c+")"},compileIndex:function(a,b){var c=this.columnize(b.columns),d=this.wrapTable(a);return"create index "+b.index+" on "+d+" ("+c+")"},compileForeign:function(){},compileDropColumn:function(){throw new Error("Drop column not supported for SQLite.")},compileDropUnique:function(a,b){return"drop index "+b.index},compileRenameTable:function(a,b){return"alter table "+this.wrapTable(a)+" rename to "+this.wrapTable(b.to)},compileRenameColumn:function(){return"__rename_column__"},typeInteger:function(){return"integer"},typeFloat:function(){return"float"},typeDecimal:function(){return"float"},typeBoolean:function(){return"tinyint"},typeEnum:function(){return"varchar"},typeDateTime:function(){return"datetime"},typeTimestamp:function(){return"datetime"},modifyIncrement:function(a,b){return!b.autoIncrement||"integer"!=b.type&&"bigInteger"!=b.type?void 0:" primary key autoincrement not null"}},f,e)},{"../schemagrammar":3,"./grammar":4,lodash:!1}],6:[function(a,b){{var c=a("lodash"),d=a("../base").ClientBase,e=a("../../lib/promise").Promise,f=a("./sqlite3/grammar").grammar,g=a("./sqlite3/schemagrammar").schemaGrammar;b.exports=d.extend({constructor:function(a){a.debug&&(this.isDebugging=!0),this.name=a.name||"knex_database",this.attachGrammars(),this.connectionSettings=a.connection},attachGrammars:function(){this.grammar=f,this.schemaGrammar=g},query:e.method(function(a){var b,d=this,f=a.toSql(a),g=a.getBindings(),h=this.getConnection(a).bind(a).then(function(h){if((d.isDebugging||this.flags.debug)&&d.debug(f,g,h,this),b=h,c.isArray(f)){var i=e.fulfilled();return e.map(f,function(b,c){return i=i.then(function(){return a.currentIndex=c,d.runQuery(h,b,g,a)})})}return d.runQuery(h,f,g,a)});return h.then(a.handleResponse).caught(function(a){var b=new Error(a.message+", sql: "+f+", bindings: "+g);throw b.sql=f,b.bindings=g,b.clientError=a,b})}),debug:function(a,b,c){"undefined"!=typeof console&&console.log("Debug: "+JSON.stringify({sql:a,bindings:b,cid:c.__cid}))},getConnection:e.method(function(a){if(a&&a.usingConnection)return a.usingConnection;var b=openDatabase(this.name,"1.0",this.name,65536),d=e.defer();return b.transaction(function(b){b.__cid=c.uniqueId("__cid"),a&&(a.usingConnection=a),d.resolve(b)}),d.promise}),startTransaction:e.method(function(){return this.getConnection()}),finishTransaction:e.method(function(a,b,c){throw c instanceof Error?c:new Error(c)})})}},{"../../lib/promise":18,"../base":1,"./sqlite3/grammar":7,"./sqlite3/schemagrammar":8,lodash:!1}],7:[function(a,b,c){var d=a("lodash"),e=(a("../../../lib/helpers").Helpers,a("../../base/sqlite3/grammar").grammar);c.grammar=d.defaults({handleResponse:function(a,b){if("select"===a.type){for(var c=[],d=0,e=b.rows.length;e>d;d++)c[d]=b.rows.item(d);return c}return"insert"===a.type?b=[b.insertId]:("delete"===a.type||"update"===a.type)&&(b=b.rowsAffected),b}},e)},{"../../../lib/helpers":15,"../../base/sqlite3/grammar":4,lodash:!1}],8:[function(a,b,c){var d=a("lodash"),e=a("../../base/sqlite3/schemagrammar").schemaGrammar;c.schemaGrammar=d.defaults({handleResponse:function(a,b){return"tableExists"===a.type?b[0].rows.length>0:"columnExists"===a.type?null!=d.findWhere(b,{name:a.bindings[1]}):b}},e)},{"../../base/sqlite3/schemagrammar":5,lodash:!1}],"./clients/browser/websql.js":[function(a,b){b.exports=a("rP8T6B")},{}],rP8T6B:[function(a,b,c){var d=a("lodash"),e=a("./base"),f=a("../../lib/builder").Builder,g=(a("../../lib/transaction").Transaction,a("../../lib/schemainterface").SchemaInterface,a("../../lib/promise").Promise),h=e.extend({dialect:"sqlite3",runQuery:g.method(function(a,b,c,d){if(!a)throw new Error("No database connection exists for the query");if("__rename_column__"===b)return this.ddl(a,b,c,d);var e=g.pending();return a.executeSql(b,c,function(a,b){e.fulfill(b,a)},function(a,b){return e.reject(b,a),!0}),e.promise}),ddl:function(a,b,c,d){return this.alterSchema.call(client,d,a)},alterSchema:function(a,b){var c,e,h=function(){return new g(function(a,c){b.executeSql(connection,function(b,c){a(c,b)},function(a,b){c(b,a)})})};return g.all([h("PRAGMA table_info("+a.table+")",[]),h('SELECT name, sql FROM sqlite_master WHERE type="table" AND name="'+a.table+'"',[])]).tap(function(b){var f=b[0],g=b[1][0];if(e=a.commands[a.currentIndex],!(c=d.findWhere(f,{name:e.from})))throw new Error("The column "+e.from+" is not in the current table");return h("ALTER TABLE "+g.name+" RENAME TO __migrate__"+g.name)}).spread(function(a,d){d=d[0];var f='"'+e.from+'" '+c.type,i='"'+e.to+'" '+c.type;return-1===d.sql.indexOf(f)?b.reject("Unable to find the column to change"):g.all([h(d.sql.replace(f,i)),h('SELECT * FROM "__migrate__'+d.name+'"')])}).spread(function(c,i){var j=new f(a.knex).transacting(b);return j.table=a.table,g.all([j.insert(d.map(i,function(a){return a[e.to]=a[e.from],d.omit(a,e.from)})),h('DROP TABLE "__migrate__'+a.table+'"')])})}});c.Client=h},{"../../lib/builder":12,"../../lib/promise":18,"../../lib/schemainterface":21,"../../lib/transaction":23,"./base":6,lodash:!1}],11:[function(b,c){var d=b("lodash"),e=b("./lib/raw").Raw,f=b("./lib/transaction").Transaction,g=b("./lib/builder").Builder,h=b("./lib/promise").Promise,i=b("./clients/base").ClientBase,j=b("./lib/schemabuilder").SchemaBuilder,k=b("./lib/schemainterface").SchemaInterface,l=function(c){var l,n;if(c instanceof i)n=c;else{if("function"==typeof a&&a.amd)throw new Error("A valid `Knex` client must be passed into the Knex constructor.");var o=c.client;if(!m[o])throw new Error(o+" is not a valid Knex client, did you misspell it?");l=b(m[o]),n=new l.Client(d.omit(c,"client"))}var p=function(a){return p.builder(a)};return p.grammar=n.grammar,p.schemaGrammar=n.schemaGrammar,p.schema={},p.migrate={},p.builder=function(a){var b=new g(p);return a?b.from(a):b},d.each(k,function(a,b){p.schema[b]=function(){var a=new j(p),c=a.table=d.first(arguments);return c?k[b].apply(a,d.rest(arguments)):h.reject(new Error("The table must be defined for the "+b+" method."))}}),p.raw=function(a,b){return new e(p).query(a,b)},p.client=n,p.VERSION="0.5.2",p.transaction=function(a){return new f(p).run(a)},d.each(["make","latest","rollback","currentVersion"],function(a){p.migrate[a]=function(){var c=b("./lib/migrate"),d=new c(p);return d[a].apply(d,arguments)}}),p},m=l.Clients={mysql:"./clients/server/mysql.js",pg:"./clients/server/postgres.js",postgres:"./clients/server/postgres.js",postgresql:"./clients/server/postgres.js",sqlite:"./clients/browser/websql.js",sqlite3:"./clients/browser/websql.js"};l.ClientBase=i,c.exports=l,l.initialize=function(a){return l(a)}},{"./clients/base":1,"./lib/builder":12,"./lib/migrate":"IXAOIc","./lib/promise":18,"./lib/raw":19,"./lib/schemabuilder":20,"./lib/schemainterface":21,"./lib/transaction":23,lodash:!1}],12:[function(a,b,c){var d=a("lodash"),e=a("./raw").Raw,f=a("./common").Common,g=a("./helpers").Helpers,h=a("./builder/joinclause").JoinClause,i=[],j=i.push,k=function(a){this.knex=a,this.client=a.client,this.grammar=a.grammar,this.reset(),d.bindAll(this,"handleResponse")},l=["asc","desc"];d.extend(k.prototype,f,{_source:"Builder",from:function(a){return a?(this.table=a,this):this.table},into:function(a){return this.table=a,this},column:function(a){return a&&j.apply(this.columns,d.isArray(a)?a:d.toArray(arguments)),this},distinct:function(a){return this.column(a),this.flags.distinct=!0,this},clone:function(){var a=new k(this.knex);a.table=this.table;for(var b=["aggregates","type","joins","wheres","orders","columns","values","bindings","grammar","groups","transaction","unions","flags","havings"],c=0,d=b.length;d>c;c++){var e=b[c];a[e]=this[e]}return a},reset:function(){this.aggregates=[],this.bindings=[],this.columns=[],this.flags={},this.havings=[],this.joins=[],this.orders=[],this.unions=[],this.values=[],this.wheres=[]},join:function(a,b,c,e,f){var g;return d.isFunction(b)?(f=c,g=new h(f||"inner",a),b.call(g,g)):(g=new h(f||"inner",a),g.on(b,c,e)),this.joins.push(g),this},where:function(a,b,c){var f=this._boolFlag||"and";if(this._boolFlag="and",d.isFunction(a))return this._whereNested(a,f);if(a instanceof e)return this.whereRaw(a.sql,a.bindings,f);if(d.isObject(a)){for(var g in a)c=a[g],this[f+"Where"](g,"=",c);return this}return 2===arguments.length&&(c=b,b="="),null==c&&"="===b?this.whereNull(a,f):d.isFunction(c)?this._whereSub(a,b,c,f):(this.wheres.push({type:"Basic",column:a,operator:b,value:c,bool:f}),this.bindings.push(c),this)},andWhere:function(){return this.where.apply(this,arguments)},orWhere:function(){return this._boolFlag="or",this.where.apply(this,arguments)},whereRaw:function(a,b,c){return b=d.isArray(b)?b:b?[b]:[],this.wheres.push({type:"Raw",sql:a,bool:c||"and"}),j.apply(this.bindings,b),this},orWhereRaw:function(a,b){return this.whereRaw(a,b,"or")},whereExists:function(a,b,c){var d=new k(this.knex);return a.call(d,d),this.wheres.push({type:c||"Exists",query:d,bool:b||"and"}),j.apply(this.bindings,d.bindings),this},orWhereExists:function(a){return this.whereExists(a,"or")},whereNotExists:function(a){return this.whereExists(a,"and","NotExists")},orWhereNotExists:function(a){return this.whereExists(a,"or","NotExists")},whereIn:function(a,b,c,e){return c||(c="and"),d.isFunction(b)?this._whereInSub(a,b,c,e||"In"):(this.wheres.push({type:e||"In",column:a,value:b,bool:c}),j.apply(this.bindings,b),this)},orWhereIn:function(a,b){return this.whereIn(a,b,"or")},whereNotIn:function(a,b){return this.whereIn(a,b,"and","NotIn")},orWhereNotIn:function(a,b){return this.whereIn(a,b,"or","NotIn")},whereNull:function(a,b,c){return this.wheres.push({type:c||"Null",column:a,bool:b||"and"}),this},orWhereNull:function(a){return this.whereNull(a,"or","Null")},whereNotNull:function(a){return this.whereNull(a,"and","NotNull")},orWhereNotNull:function(a){return this.whereNull(a,"or","NotNull")},whereBetween:function(a,b){return this.wheres.push({column:a,type:"Between",bool:"and"}),j.apply(this.bindings,b),this},orWhereBetween:function(a,b){return this.wheres.push({column:a,type:"Between",bool:"or"}),j.apply(this.bindings,b),this},groupBy:function(){return this.groups=(this.groups||[]).concat(d.toArray(arguments)),this},orderBy:function(a,b){return b instanceof e||d.contains(l,(b||"").toLowerCase())||(b="asc"),this.orders.push({column:a,direction:b}),this},union:function(a){return this._union(a,!1),this},unionAll:function(a){return this._union(a,!0),this},having:function(a,b,c,d){return a instanceof e?this.havingRaw(a.sql,a.bindings,d):(this.havings.push({column:a,operator:b||"",value:c||"",bool:d||"and"}),this.bindings.push(c),this)},orHaving:function(a,b,c){return this.having(a,b,c,"or")},havingRaw:function(a,b,c){return b=d.isArray(b)?b:b?[b]:[],this.havings.push({type:"Raw",sql:a,bool:c||"and"}),j.apply(this.bindings,b),this},orHavingRaw:function(a,b){return this.havingRaw(a,b,"or")},offset:function(a){return null==a?this.flags.offset:(this.flags.offset=a,this)},limit:function(a){return null==a?this.flags.limit:(this.flags.limit=a,this)},count:function(a){return this._aggregate("count",a)},min:function(a){return this._aggregate("min",a)},max:function(a){return this._aggregate("max",a)},sum:function(a){return this._aggregate("sum",a)},increment:function(a,b){return this._counter(a,b)},decrement:function(a,b){return this._counter(a,b,"-")},select:function(a){return a&&j.apply(this.columns,d.isArray(a)?a:d.toArray(arguments)),this._setType("select")},insert:function(a,b){return b&&this.returning(b),this.values=this.prepValues(d.clone(a)),this._setType("insert")},returning:function(a){return this.flags.returning=a,this},update:function(a,b){b&&this.returning(b);for(var c=g.sortObject(a),d=[],e=0,f=c.length;f>e;e++)d[e]=c[e][1];return this.bindings=d.concat(this.bindings||[]),this.values=c,this._setType("update")},"delete":function(){return this._setType("delete")},del:function(){return this._setType("delete")},option:function(a){return this.opts=d.extend(this.opts,a),this},truncate:function(){return this._setType("truncate")},transaction:!1,prepValues:function(a){d.isArray(a)||(a=a?[a]:[]);for(var b=0,c=a.length;c>b;b++)for(var e=a[b]=g.sortObject(a[b]),f=0,h=e.length;h>f;f++)this.bindings.push(e[f][1]);return a},_whereInSub:function(a,b,c,d){d+="Sub";var e=new k(this.knex);return b.call(e,e),this.wheres.push({type:d,column:a,query:e,bool:c}),j.apply(this.bindings,e.bindings),this},_whereNested:function(a,b){var c=new k(this.knex);return a.call(c,c),this.wheres.push({type:"Nested",query:c,bool:b}),j.apply(this.bindings,c.bindings),this},_whereSub:function(a,b,c,d){var e=new k(this.knex);return c.call(e,e),this.wheres.push({type:"Sub",column:a,operator:b,query:e,bool:d}),j.apply(this.bindings,e.bindings),this},_aggregate:function(a,b){return this.aggregates.push({type:a,columns:b}),this.type&&"select"===this.type||this._setType("select"),this},_counter:function(a,b,c){b=parseInt(b,10),isNaN(b)&&(b=1);var d={};return d[a]=this.knex.raw(this.grammar.wrap(a)+" "+(c||"+")+" "+b),this.update(d)},_union:function(a,b){var c=new k(this.knex);a.call(c,c),this.unions.push({query:c,all:b}),j.apply(this.bindings,c.bindings)}}),c.Builder=k},{"./builder/joinclause":13,"./common":14,"./helpers":15,"./raw":19,lodash:!1}],13:[function(a,b,c){var d=function(a,b){this.joinType=a,this.table=b,this.clauses=[]};d.prototype={on:function(a,b,c){return this.clauses.push({first:a,operator:b,second:c,bool:"and"}),this},andOn:function(){return this.on.apply(this,arguments)},orOn:function(a,b,c){return this.clauses.push({first:a,operator:b,second:c,bool:"or"}),this},type:function(a){return this.joinType=a,this}},c.JoinClause=d},{}],14:[function(a,b,c){{var d=a("lodash"),e=(a("./helpers").Helpers,a("./sqlstring").SqlString),f=a("./promise").Promise;[].push}c.Common={instance:function(){var a=new this.constructor(this.knex);return a.table=this.table,a},debug:function(){return this.flags.debug=!0,this},options:function(a){return this.flags.options=d.extend({},this.flags.options,a),this},exec:function(a){return this.then().nodeify(a)},then:function(a,b){return this._promise||(this._promise=f.bind(this),this._promise=this._promise.then(function(){return this.client.query(this)}).bind()),this._promise.then(a,b)},"catch":function(){return this.caught.apply(this,arguments)},caught:function(){var a=this.then();return a.caught.apply(a,arguments)},lastly:function(){var a=this.then();return a.lastly.apply(a,arguments)},"finally":function(){return this.lastly.apply(this,arguments)},tap:function(a){return this.then().tap(a)},toString:function(){var a=this,b=this.clone().toSql();return d.isArray(b)||(b=[b]),d.map(b,function(b){return e.format(b,a.getBindings())}).join("; ")},toSql:function(){return this.grammar.toSql(this)},connection:function(a){return this.usingConnection=a,this},usingConnection:!1,handleResponse:function(a){return this&&this.grammar&&this.grammar.handleResponse?this.grammar.handleResponse(this,a):a},_setType:function(a){if(this.type)throw new Error("The query type has already been set to "+this.type);return this.type=a,this},getBindings:function(){return this.grammar.getBindings(this)},transacting:function(a){if(a){if(this.transaction)throw new Error("A transaction has already been set for the current query chain");var b=this.flags;this.transaction=a,this.usingConnection=a.connection,this.forUpdate=function(){b.selectMode="ForUpdate"},this.forShare=function(){b.selectMode="ForShare"}}return this}}},{"./helpers":15,"./promise":18,"./sqlstring":22,lodash:!1}],15:[function(a,b,c){var d=a("lodash"),e=(c.Helpers={deepClone:function(a){return d.isObject(a)?JSON.parse(JSON.stringify(a)):a},skim:function(a){return d.map(a,function(a){return d.pick(a,d.keys(a))})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},sortObject:function(a){return d.sortBy(d.pairs(a),function(a){return a[0]})},extend:function(a,b){var c,e=this;c=a&&d.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},d.extend(c,e,b);var f=function(){this.constructor=c};return f.prototype=e.prototype,c.prototype=new f,a&&d.extend(c.prototype,a),c.__super__=e.prototype,c},format:function(a){var b;if(!d.isString(a)){var c=[];for(b=0;b<arguments.length;b++)c.push(inspect(arguments[b]));return c.join(" ")}b=1;for(var f=arguments,g=f.length,h=String(a).replace(e,function(a){if("%%"===a)return"%";if(b>=g)return a;switch(a){case"%s":return String(f[b++]);case"%d":return Number(f[b++]);case"%j":try{return JSON.stringify(f[b++])}catch(c){return"[Circular]"}break;default:return a}}),i=f[b];g>b;i=f[++b])h+=d.isNull(i)||!d.isObject(i)?" "+i:" "+inspect(i);return h}},/%[sdj%]/g)},{lodash:!1}],"./lib/migrate":[function(a,b){b.exports=a("IXAOIc")},{}],IXAOIc:[function(a,b){var c=b.exports=function(){};c.prototype={make:Promise.method(function(){throw new Error("Migrations are not supported")}),latest:Promise.method(function(){throw new Error("Migrations are not supported")}),rollback:Promise.method(function(){throw new Error("Migrations are not supported")}),currentVersion:Promise.method(function(){throw new Error("Migrations are not supported")})}},{}],18:[function(a,b,c){var d=a("bluebird");d.prototype.yield=function(a){return this.then(function(){return a})},d.prototype.tap=function(a){return this.then(a).yield(this)},d.prototype.ensure=d.prototype.lastly,d.prototype.otherwise=d.prototype.caught,d.resolve=d.fulfilled,d.reject=d.rejected,c.Promise=d},{bluebird:!1}],19:[function(a,b,c){var d=a("lodash"),e=a("./common").Common,f=function(a){this.knex=a,this.client=a.client,this.flags={}};d.extend(f.prototype,e,{_source:"Raw",query:function(a,b){return this.bindings=d.isArray(b)?b:b?[b]:[],this.sql=a,this},toSql:function(){return this.sql},getBindings:function(){return this.client.grammar.getBindings(this)}}),c.Raw=f},{"./common":14,lodash:!1}],20:[function(a,b,c){var d=a("lodash"),e=a("./common").Common,f=a("./helpers").Helpers,g=function(a){this.knex=a,this.client=a.client,this.grammar=a.schemaGrammar,this.columns=[],this.commands=[],this.bindings=[],this.flags={},d.bindAll(this,"handleResponse")},h=["columns","commands","bindings","flags"];d.extend(g.prototype,e,{_source:"SchemaBuilder",clone:function(){return d.reduce(h,function(a,b){return a[b]=f.deepClone(this[b]),a},this.instance(),this)},callback:function(a){return a&&a.call(this,this),this},creating:function(){for(var a=0,b=this.commands.length;b>a;a++)if("createTable"==this.commands[a].name)return!0;return!1},engine:function(a){if(!this.creating())throw new Error("The `engine` modifier may only be used while creating a table.");return this.flags.engine=a,this},charset:function(a){if(!this.creating())throw new Error("The `engine` modifier may only be used while creating a table.");return this.flags.charset=a,this},collate:function(a){if(!this.creating())throw new Error("The `engine` modifier may only be used while creating a table.");return this.flags.collation=a,this},comment:function(a){return this._addCommand("comment",{comment:a})},dropColumn:function(a){return d.isArray(a)||(a=a?[a]:[]),this._addCommand("dropColumn",{columns:a})},dropColumns:function(){return this.dropColumn(arguments)},dropPrimary:function(a){return this._dropIndexCommand("dropPrimary",a)},dropUnique:function(a){return this._dropIndexCommand("dropUnique",a)},dropIndex:function(a){return this._dropIndexCommand("dropIndex",a)},dropForeign:function(a){return this._dropIndexCommand("dropForeign",a)},primary:function(a,b){return this._indexCommand("primary",a,b)},unique:function(a,b){return this._indexCommand("unique",a,b)},index:function(a,b){return this._indexCommand("index",a,b)},renameColumn:function(a,b){return this._addCommand("renameColumn",{from:a,to:b})},foreign:function(a,b){var c,e=this._indexCommand("foreign",a,b);return d.isObject(a)&&(c=d.pick(a,"foreignColumn","foreignTable","commandOnDelete","commandOnUpdate")),d.extend(e,i,c)},increments:function(a){return this._addColumn("integer",a||"id",{isUnsigned:!0,autoIncrement:!0,length:11})},bigIncrements:function(a){return this._addColumn("bigInteger",a||"id",{isUnsigned:!0,autoIncrement:!0})
},string:function(a,b){return this._addColumn("string",a,{length:b||255})},varchar:function(a,b){return this.string(a,b)},text:function(a,b){return this._addColumn("text",a,{length:b||!1})},integer:function(a,b){return this._addColumn("integer",a,{length:b||11})},bigInteger:function(a){return this._addColumn("bigInteger",a)},tinyInteger:function(a){return this._addColumn("tinyInteger",a)},tinyint:function(a){return this.tinyInteger(a)},"float":function(a,b,c){return this._addColumn("float",a,{precision:null==b?8:b,scale:null==c?2:c})},decimal:function(a,b,c){return this._addColumn("decimal",a,{precision:null==b?8:b,scale:null==c?2:c})},"boolean":function(a){return this.bool(a)},bool:function(a){return this._addColumn("boolean",a)},date:function(a){return this._addColumn("date",a)},dateTime:function(a){return this._addColumn("dateTime",a)},time:function(a){return this._addColumn("time",a)},timestamp:function(a){return this._addColumn("timestamp",a)},timestamps:function(){this.dateTime("created_at"),this.dateTime("updated_at")},"enum":function(a,b){return this.enu(a,b)},enu:function(a,b){return d.isArray(b)||(b=[b]),this._addColumn("enum",a,{allowed:b})},bit:function(a,b){return this._addColumn("bit",a,{length:b||!1})},binary:function(a){return this._addColumn("binary",a)},json:function(a){return this._addColumn("json",a)},uuid:function(a){return this._addColumn("uuid",a)},specificType:function(a,b){return this._addColumn("specificType",a,{specific:b})},_dropIndexCommand:function(a,b){var c=[];return d.isArray(b)&&(c=b,b=null),this._indexCommand(a,c,b)},_indexCommand:function(a,b,c){if(c||(c=null),d.isArray(b)||(b=b?[b]:[]),null===c){var e=this.table.replace(/\.|-/g,"_");c=(e+"_"+d.map(b,function(a){return a.name||a}).join("_")+"_"+a).toLowerCase()}return this._addCommand(a,{index:c,columns:b})},_addColumn:function(a,b,c){if(!b)throw new Error("A `name` must be defined to add a column");var e=d.extend({type:a,name:b},j,c);return this.columns.push(e),e},_addCommand:function(a,b){var c=d.extend({name:a},b);return this.commands.push(c),c}});var i={references:function(a){return this.isForeign=!0,this.foreignColumn=a||null,this},inTable:function(a){return this.foreignTable=a||null,this},onDelete:function(a){return this.commandOnDelete=a||null,this},onUpdate:function(a){return this.commandOnUpdate=a||null,this}},j=d.extend({defaultTo:function(a){return"boolean"===this.type&&("false"===a&&(a=0),a=a?1:0),this.defaultValue=a,this},unsigned:function(){return this.isUnsigned=!0,this},nullable:function(){return this.isNullable=!0,this},notNull:function(){return this.isNullable=!1,this},notNullable:function(){return this.isNullable=!1,this},index:function(a){return this.isIndex=a||!0,this},primary:function(a){return this.autoIncrement||(this.isPrimary=a||!0),this},unique:function(a){return this.isUnique=a||!0,this},after:function(a){return this.isAfter=a,this},comment:function(a){return this.isCommented=a||null,this}},i);c.SchemaBuilder=g},{"./common":14,"./helpers":15,lodash:!1}],21:[function(a,b,c){var d={table:function(a){return this.callback(a),this._setType("table")},createTable:function(a){return this._addCommand("createTable"),this.callback(a),this._setType("createTable")},dropTable:function(){return this._addCommand("dropTable"),this._setType("dropTable")},dropTableIfExists:function(){return this._addCommand("dropTableIfExists"),this._setType("dropTableIfExists")},renameTable:function(a){return this._addCommand("renameTable",{to:a}),this._setType("renameTable")},hasTable:function(){return this.bindings.push(this.table),this._addCommand("tableExists"),this._setType("tableExists")},hasColumn:function(a){return this.bindings.push(this.table,a),this._addCommand("columnExists"),this._setType("columnExists")}};c.SchemaInterface=d},{}],22:[function(a,b,c){function d(a){return 10>a?"0"+a:a}function e(a){if("Z"==a)return 0;var b=a.match(/([\+\-\s])(\d\d):?(\d\d)?/);return b?("-"==b[1]?-1:1)*(parseInt(b[2],10)+(b[3]?parseInt(b[3],10):0)/60)*60:!1}var f={},g=a("lodash");f.format=function(a,b,c){return b=[].concat(b),a.replace(/\?/g,function(a){return b.length?f.escape(b.shift(),c):a})},f.escape=function(a,b){if(void 0===a||null===a)return"NULL";switch(typeof a){case"boolean":return a?"true":"false";case"number":return a+""}return a instanceof Date&&(a=f.dateToString(a,b||"Z")),"undefined"!=typeof Buffer&&Buffer.isBuffer(a)?f.bufferToString(a):g.isArray(a)?f.arrayToList(a,b):("object"==typeof a&&(a=a.toString()),a=a.replace(/[\0\n\r\b\t\\\'\"\x1a]/g,function(a){switch(a){case"\x00":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"	":return"\\t";case"":return"\\Z";default:return"\\"+a}}),"'"+a+"'")},f.arrayToList=function(a,b){return a.map(function(a){return Array.isArray(a)?"("+f.arrayToList(a)+")":f.escape(a,!0,b)}).join(", ")},f.dateToString=function(a,b){var c=new Date(a);if("local"!=b){var f=e(b);c.setTime(c.getTime()+6e4*c.getTimezoneOffset()),f!==!1&&c.setTime(c.getTime()+6e4*f)}var g=c.getFullYear(),h=d(c.getMonth()+1),i=d(c.getDate()),j=d(c.getHours()),k=d(c.getMinutes()),l=d(c.getSeconds());return g+"-"+h+"-"+i+" "+j+":"+k+":"+l},f.bufferToString=function(a){var b="";try{b=a.toString("hex")}catch(c){for(var e=0;e<a.length;e++){var f=a[e];b+=d(f.toString(16))}}return"X'"+b+"'"},c.SqlString=f},{lodash:!1}],23:[function(a,b,c){var d=a("./promise").Promise,e=a("lodash"),f=function(a){this.client=a.client};f.prototype={run:function(a,b){return this.client.startTransaction(b).bind(this).then(this.getContainerObject).then(this.initiateDeferred(a)).bind()},getContainerObject:function(a){var b=this.client,c={commit:function(a){b.finishTransaction("commit",this,a)},rollback:function(a){b.finishTransaction("rollback",this,a)},connection:a};return e.bindAll(c,"commit","rollback"),c},initiateDeferred:function(a){return function(b){var c=b.dfd=d.pending();return a(b),c.promise}}},c.Transaction=f},{"./promise":18,lodash:!1}]},{},[11])(11)});