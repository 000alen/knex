<!DOCTYPE html><html lang="en"><head><title>lib/query/builder</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="lib/query/builder"><meta name="groc-project-path" content="lib/query/builder.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/query/builder.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="builder">Builder</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inherits</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;inherits&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Raw</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../raw&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">helpers</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../helpers&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">JoinClause</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./joinclause&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Typically called from <code>knex.builder</code>,
start a new query building chain.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">QueryBuilder</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span>     <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span>     <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Internal flags used in the builder.</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">_joinFlag</span>  <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_boolFlag</span>  <span class="o">=</span> <span class="s1">&#39;and&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">inherits</span><span class="p">(</span><span class="nx">QueryBuilder</span><span class="p">,</span> <span class="nx">EventEmitter</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>All operators used in the <code>where</code> clause generation.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">operators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;not like&#39;</span><span class="p">,</span>
  <span class="s1">&#39;between&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;@&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;@&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">nullOperators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;is not&#39;</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Valid values for the <code>order by</code> clause generation.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">orderBys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">];</span>

<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toQuery</span><span class="p">();</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convert the current query "toSQL"</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toSQL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">QueryCompiler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">QueryCompiler</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">QueryCompiler</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">toSQL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">||</span> <span class="s1">&#39;select&#39;</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a shallow clone of the current query builder.
TODO: Test this!!</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cloned</span>            <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">();</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_method</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_method</span><span class="p">;</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_single</span>      <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">);</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_options</span>     <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_options</span><span class="p">);</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_statements</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_errors</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_debug</span>       <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_debug</span><span class="p">;</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_transacting</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transacting</span><span class="p">;</span>
    <span class="nx">cloned</span><span class="p">.</span><span class="nx">_connection</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_connection</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">cloned</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="select">Select</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the values for a <code>select</code> query,
which is the same as specifying the columns.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a column or columns to the list of "columns"
being selected on the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">columns</span> <span class="o">=</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">column</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">normalizeArr</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the <code>tableName</code> on the query.
Alias to "from" for select and "into" for insert statements
e.g. builder.insert({a: value}).into('tableName')</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tableName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="nx">tableName</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">table</span><span class="p">;</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">into</span> <span class="o">=</span> <span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">table</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>distinct</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">distinct</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">normalizeArr</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
    <span class="nx">distinct</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a join clause to the query, allowing for advanced joins
with an anonymous function as the second argument.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">join</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">helpers</span><span class="p">.</span><span class="nx">deprecate</span><span class="p">(</span><span class="s1">&#39;The five argument join syntax is now deprecated, &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;please check the docs and update your code.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]).</span><span class="nx">join</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">second</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">join</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">first</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">helpers</span><span class="p">.</span><span class="nx">deprecate</span><span class="p">(</span><span class="s1">&#39;The [table, fn, type] join syntax is deprecated, &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;please check the docs and update your code.&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="nx">join</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">first</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">join</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JoinClause</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">());</span>
    <span class="nx">first</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">join</span><span class="p">,</span> <span class="nx">join</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">join</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JoinClause</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">());</span>
    <span class="nx">join</span><span class="p">.</span><span class="nx">on</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">join</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">join</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>JOIN blocks:</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">innerJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;inner&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leftJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leftOuterJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;left outer&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rightJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rightOuterJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;right outer&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">outerJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;outer&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fullOuterJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;full outer&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">crossJoin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinType</span><span class="p">(</span><span class="s1">&#39;cross&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The where function can be used in several ways:
The most basic is <code>where(key, value)</code>, which expands to
where key = value.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">where</span> <span class="o">=</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">andWhere</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check if the column is a function, in which case it's
a where statement wrapped in parens.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">column</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereWrapped</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow a raw statement to be passed along to the query.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="nx">column</span> <span class="k">instanceof</span> <span class="nx">Raw</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_whereRaw</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allows <code>where({id: 2})</code> syntax.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">column</span><span class="p">))</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_objectWhere</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Enable the where('key', value) syntax, only when there
are explicitly two arguments passed, so it's not possible to
do where('key', '!=') and have that turn into where key != null</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span>    <span class="o">=</span> <span class="nx">operator</span><span class="p">;</span>
    <span class="nx">operator</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>lower case the operator for comparison purposes</p></div></div><div class="code"><div class="wrapper">  <span class="nx">operator</span> <span class="o">=</span> <span class="nx">operator</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ensure that the operator / query combo is legal.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">operators</span><span class="p">,</span> <span class="nx">operator</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">nullOperators</span><span class="p">,</span> <span class="nx">operator</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;is&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">bool</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">bool</span><span class="p">,</span> <span class="s1">&#39;NotNull&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid where in clause&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid operator: &#39;</span> <span class="o">+</span> <span class="nx">operator</span><span class="p">));</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the value is null, and the operator is equals, assume that we're
going for a <code>whereNull</code> statement here.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereBasic&#39;</span><span class="p">,</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">operator</span><span class="o">:</span> <span class="nx">operator</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Processes an object literal provided in a "where" clause.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_objectWhere</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">boolVal</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">boolVal</span> <span class="o">+</span> <span class="s1">&#39;Where&#39;</span><span class="p">](</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds an <code>or where</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhere</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>[Deprecated]</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereRaw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">helpers</span><span class="p">.</span><span class="nx">deprecate</span><span class="p">(</span><span class="s1">&#39;Knex: .whereRaw is deprecated, please use .where(knex.raw(QUERY, [bindings]))&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_whereRaw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a raw <code>where</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_whereRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sql</span> <span class="k">instanceof</span> <span class="nx">Raw</span> <span class="o">?</span> <span class="nx">sql</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Raw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereRaw&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">raw</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper for compiling any advanced <code>where</code> queries.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereWrapped</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereWrapped&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where exists</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">not</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereExists&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
    <span class="nx">not</span><span class="o">:</span> <span class="nx">not</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(),</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds an <code>or where exists</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereExists</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where not exists</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereNotExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereExists</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where not exists</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereNotExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereExists</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where in</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereIn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">not</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereIn&#39;</span><span class="p">,</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">values</span><span class="p">,</span>
    <span class="nx">not</span><span class="o">:</span> <span class="nx">not</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where in</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereIn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereIn</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where not in</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereNotIn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereIn</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where not in</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereNotIn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereIn</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where null</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereNull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">not</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereNull&#39;</span><span class="p">,</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">not</span><span class="o">:</span> <span class="nx">not</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where null</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereNull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where not null</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereNotNull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="s1">&#39; is not null&#39;</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where not null</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereNotNull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereNull</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="s1">&#39; is not null&#39;</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where between</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereBetween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">not</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">values</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The second argument to whereBetween must be an array.&#39;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;You must specify 2 values for the whereBetween clause&#39;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;whereBetween&#39;</span><span class="p">,</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">values</span><span class="p">,</span>
    <span class="nx">not</span><span class="o">:</span> <span class="nx">not</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>where not between</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">whereNotBetween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">whereBetween</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where between</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereBetween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereBetween</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>or where not between</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orWhereNotBetween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">whereNotBetwen</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>group by</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">groupBy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">normalizeArr</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>order by</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orderBy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">direction</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">direction</span> <span class="k">instanceof</span> <span class="nx">Raw</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">orderBys</span><span class="p">,</span> <span class="p">(</span><span class="nx">direction</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()))</span> <span class="nx">direction</span> <span class="o">=</span> <span class="s1">&#39;asc&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">direction</span><span class="o">:</span> <span class="nx">direction</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add a union statement to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">union</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;union&#39;</span><span class="p">,</span>
    <span class="nx">clause</span><span class="o">:</span> <span class="s1">&#39;union&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
    <span class="nx">wrap</span><span class="o">:</span> <span class="nx">wrap</span> <span class="o">||</span> <span class="kc">false</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a union all statement to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unionAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;union&#39;</span><span class="p">,</span>
    <span class="nx">clause</span><span class="o">:</span> <span class="s1">&#39;union all&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
    <span class="nx">wrap</span><span class="o">:</span> <span class="nx">wrap</span> <span class="o">||</span> <span class="kc">false</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a <code>having</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">having</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">column</span> <span class="k">instanceof</span> <span class="nx">Raw</span> <span class="o">&amp;&amp;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_havingRaw</span><span class="p">(</span><span class="nx">column</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;having&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;havingBasic&#39;</span><span class="p">,</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">operator</span><span class="o">:</span> <span class="nx">operator</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds an <code>or having</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orHaving</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">having</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>[Deprecated]</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">havingRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">helpers</span><span class="p">.</span><span class="nx">deprecate</span><span class="p">(</span><span class="s1">&#39;Knex: .havingRaw is deprecated, please use .having(knex.raw(QUERY, [bindings]))&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_havingRaw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orHavingRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">).</span><span class="nx">havingRaw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Adds a raw <code>having</code> clause to the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_havingRaw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sql</span> <span class="k">instanceof</span> <span class="nx">Raw</span> <span class="o">?</span> <span class="nx">sql</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Raw</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;having&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;havingRaw&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">raw</span><span class="p">,</span>
    <span class="nx">bool</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bool</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only allow a single "offset" to be set for the current query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only allow a single "limit" to be set for the current query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the "count" result of the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_aggregate</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">column</span> <span class="o">||</span> <span class="s1">&#39;*&#39;</span><span class="p">));</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the minimum value of a given column.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_aggregate</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nx">column</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the maximum value of a given column.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_aggregate</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nx">column</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the sum of the values of a given column.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_aggregate</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="nx">column</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the average of the values of a given column.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">avg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_aggregate</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="nx">column</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Increments a column's value by the specified amount.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">increment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">amount</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_counter</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Decrements a column's value by the specified amount.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decrement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">amount</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_counter</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the values for a <code>select</code> query, informing that only the first
row should be returned (limit 1).</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pluck a column from a query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pluck</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;pluck&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;pluck&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">column</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="insert-amp-update">Insert &amp; Update</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the values for an <code>insert</code> query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">insert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">returning</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;insert&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">returning</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="nx">returning</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">insert</span> <span class="o">=</span> <span class="nx">values</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the values for an <code>update</code>, allowing for both
<code>.update(key, value, [returning])</code> and <code>.update(obj, [returning])</code> syntaxes.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">returning</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">values</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">[</span><span class="nx">values</span><span class="p">]</span> <span class="o">=</span> <span class="nx">returning</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ret</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">obj</span> <span class="o">=</span> <span class="nx">values</span><span class="p">;</span>
    <span class="nx">ret</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">ret</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the returning value for the query.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">returning</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">returning</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">returning</span> <span class="o">=</span> <span class="nx">returning</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="delete">Delete</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Executes a delete statement on the query;</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">del</span> <span class="o">=</span>
<span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="k">delete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;del&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">ret</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Truncates a table, ends the query chain.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">truncate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;truncate&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieves columns for the table specified by <code>knex(tableName)</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">columnInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;columnInfo&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set a lock for update constraint.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forUpdate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">lock</span> <span class="o">=</span> <span class="s1">&#39;forUpdate&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set a lock for share constraint.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forShare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">lock</span> <span class="o">=</span> <span class="s1">&#39;forShare&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper for the incrementing/decrementing queries.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_counter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">symbol</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">amt</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">amount</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">amt</span><span class="p">))</span> <span class="nx">amt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="s1">&#39;counter&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_single</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">column</span><span class="p">,</span>
    <span class="nx">amount</span><span class="o">:</span> <span class="nx">amt</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="p">(</span><span class="nx">symbol</span> <span class="o">||</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper to get or set the "boolFlag" value.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_bool</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_boolFlag</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_boolFlag</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_boolFlag</span> <span class="o">=</span> <span class="s1">&#39;and&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper to get or set the "joinFlag" value.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_joinType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_joinFlag</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_joinFlag</span> <span class="o">||</span> <span class="s1">&#39;inner&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_joinFlag</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper for compiling any aggregate queries.</p></div></div><div class="code"><div class="wrapper"><span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_aggregate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_statements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
    <span class="nx">grouping</span><span class="o">:</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;aggregate&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">column</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Attach all of the top level promise methods that should be chainable.</p></div></div><div class="code"><div class="wrapper"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../interface&#39;</span><span class="p">)(</span><span class="nx">QueryBuilder</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">QueryBuilder</span><span class="p">;</span></div></div></div></div></body></html>